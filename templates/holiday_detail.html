{% extends 'base.html' %}
{% load static %}

{% block title %}{{ holiday.title }} - Партизан{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="holiday-detail">
            <div class="holiday-main">
                {% if holiday.image %}
                <img src="{{ holiday.image.url }}" alt="{{ holiday.title }}" class="holiday-detail-image">
                {% endif %}
                
                <div class="holiday-detail-info">
                    <h1 class="page-title">{{ holiday.title }}</h1>
                    <p class="holiday-category">{{ holiday.category.name }}</p>
                    
                    <div class="holiday-meta">
                        <div class="meta-item">
                            <i class="far fa-clock"></i>
                            <span>{{ holiday.duration }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-child"></i>
                            <span>{{ holiday.min_age }}-{{ holiday.max_age }} лет</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-users"></i>
                            <span>До {{ holiday.max_children }} детей</span>
                        </div>
                        <div class="meta-item price">
                            <i class="fas fa-ruble-sign"></i>
                            <span>{{ holiday.price }} ₽</span>
                        </div>
                    </div>
                    
                    <div class="holiday-description-full">
                        {{ holiday.description|linebreaks }}
                    </div>
                </div>
            </div>
            
            <div class="order-section">
                <h2>Быстрая заявка</h2>
                <p>Оставьте номер телефона и мы вам перезвоним</p>
                
                <form id="quick-order-form" class="order-form">
                    {% csrf_token %}
                    <input type="hidden" name="holiday_id" value="{{ holiday.id }}">
                    <div class="form-group">
                        <input type="tel" name="phone" placeholder="Ваш номер телефона" required class="form-input">
                    </div>
                    <button type="submit" class="btn btn-primary">Заказать звонок</button>
                </form>
                <div id="quick-order-message" class="form-message" style="display: none;"></div>
            </div>
            
            <div class="order-section">
                <h2>Полная заявка на праздник</h2>
                
                <form id="full-order-form" class="order-form">
                    {% csrf_token %}
                    <input type="hidden" name="holiday_id" value="{{ holiday.id }}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="full_name">ФИО *</label>
                            <input type="text" id="full_name" name="full_name" placeholder="Иванов Иван Иванович" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="phone">Номер телефона *</label>
                            <input type="tel" id="phone" name="phone" placeholder="+7 (999) 123-45-67" required class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="children_count">Количество детей *</label>
                            <input type="number" id="children_count" name="children_count" placeholder="Например: 5" min="1" max="{{ holiday.max_children }}" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="age_of_children">Возраст детей *</label>
                            <input type="text" id="age_of_children" name="age_of_children" placeholder="Например: 5, 7, 10 лет" required class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="date-select">Выберите дату и время проведения *</label>
                        <select id="date-select" name="date_id" required class="form-input">
                            <option value="">-- Выберите дату и время --</option>
                            {% for date_group in available_dates_grouped %}
                                <optgroup label="{{ date_group.date }}">
                                    {% for slot in date_group.slots %}
                                        <option value="{{ slot.id }}" 
                                                data-available="{{ slot.available }}"
                                                {% if slot.available <= 0 %}disabled{% endif %}>
                                            {{ slot.time }} 
                                            {% if slot.available > 0 %}
                                                (осталось {{ slot.available }} из 2 мест)
                                            {% else %}
                                                (нет свободных мест)
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% empty %}
                                <option value="" disabled>Нет доступных дат</option>
                            {% endfor %}
                        </select>
                        
                        <div class="schedule-info">
                            <p><i class="fas fa-clock"></i> Режим работы: Пн-Пт 9:00-21:00, Сб-Вс 10:00-19:00</p>
                            <p><i class="fas fa-info-circle"></i> На каждый временной слот максимум 2 заявки</p>
                            <p><i class="fas fa-calendar-alt"></i> Доступны даты на месяц вперед</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Дополнительные пожелания</label>
                        <textarea id="notes" name="notes" placeholder="Особые пожелания, аллергии, предпочтения, удобное время..." class="form-input" rows="4"></textarea>
                    </div>
                    
                    <div class="form-footer">
                        <button type="submit" class="btn btn-primary btn-large">
                            <i class="fas fa-paper-plane"></i> Отправить заявку
                        </button>
                    </div>
                </form>
                <div id="full-order-message" class="form-message" style="display: none;"></div>
            </div>
        </div>
    </div>
</section>

<style>
/* Основные стили */
.form-message {
    margin-top: 15px;
    padding: 10px 15px;
    border-radius: 5px;
    font-weight: 500;
}

.form-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.form-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.order-section {
    margin-bottom: 30px;
    padding: 25px;
    background: #f9f9f9;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.order-section h2 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
}

.form-input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
}

.form-input:disabled {
    background: #f5f5f5;
    cursor: not-allowed;
}

select.form-input {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 15px;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary:hover {
    background-color: var(--dark-color);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
}

.btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.btn-large {
    width: 100%;
    padding: 15px !important;
    font-size: 1.1rem !important;
}

.schedule-info {
    margin-top: 15px;
    padding: 15px;
    background: #e8f5e9;
    border-radius: 8px;
    font-size: 0.9rem;
    border-left: 4px solid var(--primary-color);
}

.schedule-info p {
    margin: 8px 0;
    color: #2e7d32;
    display: flex;
    align-items: center;
    gap: 10px;
}

.schedule-info i {
    color: var(--primary-color);
    width: 20px;
    font-size: 1.1rem;
}

optgroup {
    font-weight: bold;
    color: var(--primary-color);
    background: #f1f8e9;
    padding: 5px;
}

option {
    padding: 8px;
    font-size: 0.95rem;
}

option:disabled {
    color: #999;
    background: #f5f5f5;
}

option:checked {
    background: var(--primary-color) !important;
    color: white;
}

.form-footer {
    margin-top: 25px;
}

/* Адаптивность */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .order-section {
        padding: 20px;
    }
    
    .schedule-info p {
        flex-wrap: wrap;
    }
}
</style>

<!-- Выносим данные Django в data-атрибуты -->
<div id="holiday-data" 
     data-holiday-id="{{ holiday.id }}"
     data-max-children="{{ holiday.max_children }}"
     data-quick-order-url="{% url 'create_quick_order' %}"
     data-full-order-url="{% url 'create_full_order' %}"
     style="display: none;"></div>

<script>
(function() {
    'use strict';
    
    // Получаем данные из data-атрибутов
    const holidayData = document.getElementById('holiday-data');
    if (!holidayData) return;
    
    const maxChildren = parseInt(holidayData.dataset.maxChildren) || 10;
    const quickOrderUrl = holidayData.dataset.quickOrderUrl;
    const fullOrderUrl = holidayData.dataset.fullOrderUrl;

    // Функция для отображения сообщения
    function showMessage(elementId, message, isSuccess) {
        const messageEl = document.getElementById(elementId);
        if (!messageEl) return;
        
        messageEl.textContent = message;
        messageEl.className = 'form-message ' + (isSuccess ? 'success' : 'error');
        messageEl.style.display = 'block';
        
        setTimeout(function() {
            messageEl.style.display = 'none';
        }, 5000);
    }

    // Маска для телефона
    function phoneMask(input) {
        if (!input) return;
        
        input.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value[0] === '7' || value[0] === '8') {
                    value = value.substring(1);
                }
                
                let formatted = '+7 ';
                if (value.length > 0) formatted += '(' + value.substring(0, 3);
                if (value.length > 3) formatted += ') ' + value.substring(3, 6);
                if (value.length > 6) formatted += '-' + value.substring(6, 8);
                if (value.length > 8) formatted += '-' + value.substring(8, 10);
                
                this.value = formatted;
            }
        });
    }

    // Валидация формы
    function validateForm(form) {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        let firstInvalid = null;
        
        requiredFields.forEach(function(field) {
            if (!field.value.trim()) {
                field.style.borderColor = '#dc3545';
                isValid = false;
                if (!firstInvalid) firstInvalid = field;
            } else {
                field.style.borderColor = '#e0e0e0';
            }
        });
        
        if (!isValid && firstInvalid) {
            firstInvalid.focus();
        }
        
        return isValid;
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Маска для телефона
        document.querySelectorAll('input[type="tel"]').forEach(phoneMask);

        // Ограничение количества детей
        const childrenCountInput = document.getElementById('children_count');
        if (childrenCountInput) {
            childrenCountInput.addEventListener('input', function() {
                if (this.value > maxChildren) {
                    this.value = maxChildren;
                    showMessage('full-order-message', 'Максимальное количество детей: ' + maxChildren, false);
                }
            });
        }

        // Quick order form
        const quickForm = document.getElementById('quick-order-form');
        if (quickForm && quickOrderUrl) {
            quickForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!validateForm(this)) {
                    showMessage('quick-order-message', 'Пожалуйста, заполните номер телефона', false);
                    return;
                }
                
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
                
                fetch(quickOrderUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        showMessage('quick-order-message', data.message, true);
                        quickForm.reset();
                    } else {
                        let errorMessage = 'Ошибка при отправке';
                        if (data.errors) {
                            errorMessage = Object.values(data.errors).flat().join(', ');
                        } else if (data.message) {
                            errorMessage = data.message;
                        }
                        showMessage('quick-order-message', errorMessage, false);
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showMessage('quick-order-message', 'Ошибка соединения. Попробуйте позже.', false);
                })
                .finally(function() {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            });
        }

        // Full order form
        const fullForm = document.getElementById('full-order-form');
        if (fullForm && fullOrderUrl) {
            fullForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!validateForm(this)) {
                    showMessage('full-order-message', 'Пожалуйста, заполните все обязательные поля', false);
                    return;
                }
                
                const dateSelect = document.getElementById('date-select');
                if (!dateSelect || !dateSelect.value) {
                    showMessage('full-order-message', 'Пожалуйста, выберите дату и время', false);
                    if (dateSelect) {
                        dateSelect.style.borderColor = '#dc3545';
                        dateSelect.focus();
                    }
                    return;
                }
                
                // Получаем информацию о выбранном слоте
                const selectedOption = dateSelect.options[dateSelect.selectedIndex];
                const optionText = selectedOption.textContent;
                const optgroupLabel = selectedOption.closest('optgroup') ? selectedOption.closest('optgroup').label : '';
                const available = selectedOption.getAttribute('data-available');
                
                // Проверяем, не занят ли слот
                if (available <= 0) {
                    showMessage('full-order-message', 'Этот временной слот уже занят. Выберите другое время.', false);
                    return;
                }
                
                // Подтверждение выбора
                if (!confirm('Подтвердите выбор:\n\nДата: ' + optgroupLabel + '\nВремя: ' + optionText + '\n\nОтправить заявку?')) {
                    return;
                }
                
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
                
                fetch(fullOrderUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        showMessage('full-order-message', data.message, true);
                        fullForm.reset();
                        
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    } else {
                        let errorMessage = 'Ошибка при отправке';
                        if (data.errors) {
                            errorMessage = Object.values(data.errors).flat().join(', ');
                        } else if (data.message) {
                            errorMessage = data.message;
                        }
                        showMessage('full-order-message', errorMessage, false);
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showMessage('full-order-message', 'Ошибка соединения. Попробуйте позже.', false);
                })
                .finally(function() {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            });
        }

        // Подсветка выбранной даты
        const dateSelect = document.getElementById('date-select');
        if (dateSelect) {
            dateSelect.addEventListener('change', function() {
                this.style.borderColor = '#e0e0e0';
            });
        }
    });
})();
</script>
{% endblock %}